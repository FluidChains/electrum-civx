from electrum_exos import transaction
from electrum_exos.transaction import TxOutputForUI
from electrum_exos.bitcoin import TYPE_ADDRESS
from electrum_exos.keystore import xpubkey_to_address
from electrum_exos.util import bh2u, bfh

from . import SequentialTestCase, TestCaseForTestnet
from .test_bitcoin import needs_test_with_all_ecc_implementations

unsigned_blob = '45505446ff0001000000012a5c9a94fcde98f5581cd00162c60a13936ceb75389ea65bf38633b424eb4031000000005701ff4c53ff0488b21e03ef2afea18000000089689bff23e1e7fb2f161daa37270a97a3d8c2e537584b2d304ecb47b86d21fc021b010d3bd425f8cf2e04824bfdf1f1f5ff1d51fadd9a41f9e3fb8dd3403b1bfe00000000ffffffff0140420f00000000001976a914230ac37834073a42146f11ef8414ae929feaafc388ac00000000'
signed_blob = '010000002be41c5d01284c864811a9c22a7a07fb708aac83605bc3d3e76f134b0cdc2fc2c769bb45ac000000006b483045022100bb1e109a2f03b9f610955cb4e144c15b22e95bb8ff4bd75a961109ddbabb250f02202c5d6f68fb5eccbafe7e712ee30b132f828705d579bc66383a1b6c0831b96d130121023f7b5d47f659e5bf078c84f74a4fb9e35578ba5c51019c0021794019c500d16efdffffff0280969800000000001976a914eaf268466253b2ceba226ea88cd3a7573bd5908b88ac941d5d05000000001976a914da5ba9904d5d087b7c6e929f8a78776c84d9874088ac54d80800'
v2_blob = "010000002be41c5d01284c864811a9c22a7a07fb708aac83605bc3d3e76f134b0cdc2fc2c769bb45ac000000006b483045022100bb1e109a2f03b9f610955cb4e144c15b22e95bb8ff4bd75a961109ddbabb250f02202c5d6f68fb5eccbafe7e712ee30b132f828705d579bc66383a1b6c0831b96d130121023f7b5d47f659e5bf078c84f74a4fb9e35578ba5c51019c0021794019c500d16efdffffff0280969800000000001976a914eaf268466253b2ceba226ea88cd3a7573bd5908b88ac941d5d05000000001976a914da5ba9904d5d087b7c6e929f8a78776c84d9874088ac54d80800"
signed_segwit_blob = "01000000000101b66d722484f2db63e827ebf41d02684fed0c6550e85015a6c9d41ef216a8a6f00000000000fdffffff0280c3c90100000000160014b65ce60857f7e7892b983851c2a8e3526d09e4ab64bac30400000000160014c478ebbc0ab2097706a98e10db7cf101839931c4024730440220789c7d47f876638c58d98733c30ae9821c8fa82b470285dcdf6db5994210bf9f02204163418bbc44af701212ad42d884cc613f3d3d831d2d0cc886f767cca6e0235e012103083a6dc250816d771faa60737bfe78b23ad619f6b458e0a1f1688e3a0605e79c00000000"

signed_blob_signatures = ['3046022100a82bbc57a0136751e5433f41cf000b3f1a99c6744775e76ec764fb78c54ee100022100f9e80b7de89de861dc6fb0c1429d5da72c2b6b2ee2406bc9bfb1beedd729d98501', ]

class TestBCDataStream(SequentialTestCase):

    def test_compact_size(self):
        s = transaction.BCDataStream()
        values = [0, 1, 252, 253, 2**16-1, 2**16, 2**32-1, 2**32, 2**64-1]
        for v in values:
            s.write_compact_size(v)

        with self.assertRaises(transaction.SerializationError):
            s.write_compact_size(-1)

        self.assertEqual(bh2u(s.input),
                          '0001fcfdfd00fdfffffe00000100feffffffffff0000000001000000ffffffffffffffffff')
        for v in values:
            self.assertEqual(s.read_compact_size(), v)

        with self.assertRaises(transaction.SerializationError):
            s.read_compact_size()

    def test_string(self):
        s = transaction.BCDataStream()
        with self.assertRaises(transaction.SerializationError):
            s.read_string()

        msgs = ['Hello', ' ', 'World', '', '!']
        for msg in msgs:
            s.write_string(msg)
        for msg in msgs:
            self.assertEqual(s.read_string(), msg)

        with self.assertRaises(transaction.SerializationError):
            s.read_string()

    def test_bytes(self):
        s = transaction.BCDataStream()
        s.write(b'foobar')
        self.assertEqual(s.read_bytes(3), b'foo')
        self.assertEqual(s.read_bytes(2), b'ba')
        self.assertEqual(s.read_bytes(4), b'r')
        self.assertEqual(s.read_bytes(1), b'')

class TestTransaction(SequentialTestCase):

   
    @needs_test_with_all_ecc_implementations
    def test_tx_signed(self):
        expected = { 
            'partial':False,
            'version':1,
            'time':1562174507,
            'segwit_ser':False,
            'inputs':[  
                {  
                    'prevout_hash':'ac45bb69c7c22fdc0c4b136fe7d3c35b6083ac8a70fb077a2ac2a91148864c28',
                    'prevout_n':0,
                    'scriptSig':'483045022100bb1e109a2f03b9f610955cb4e144c15b22e95bb8ff4bd75a961109ddbabb250f02202c5d6f68fb5eccbafe7e712ee30b132f828705d579bc66383a1b6c0831b96d130121023f7b5d47f659e5bf078c84f74a4fb9e35578ba5c51019c0021794019c500d16e',
                    'sequence':4294967293,
                    'type':'unknown',
                    'address':None,
                    'num_sig':0
                }
            ],
            'outputs':[  
                {  
                    'value':10000000,
                    'type':0,
                    'address':'CdtB5gj32rcnAD8HtMRdQ1HmWDtG3RCoAD',
                    'scriptPubKey':'76a914eaf268466253b2ceba226ea88cd3a7573bd5908b88ac',
                    'prevout_n':0
                },
                {  
                    'value':89988500,
                    'type':0,
                    'address':'CcNTgfxrLYPF5bz6CJiZ1xVRZzUQjDhqFf',
                    'scriptPubKey':'76a914da5ba9904d5d087b7c6e929f8a78776c84d9874088ac',
                    'prevout_n':1
                }
            ],
            'lockTime':579668
        }
        

        tx = transaction.Transaction(signed_blob)
        
        self.assertEqual(tx.deserialize(), expected)
        self.assertEqual(tx.deserialize(), None)
        self.assertEqual(tx.as_dict(), {'hex': signed_blob, 'complete': True, 'final': False})

        self.assertEqual(tx.serialize(), signed_blob)

        tx.update_signatures(signed_blob_signatures)

        self.assertEqual(tx.estimated_total_size(), 230)
        self.assertEqual(tx.estimated_base_size(), 230)
        self.assertEqual(tx.estimated_weight(), 920)
        self.assertEqual(tx.estimated_size(), 230)

    def test_estimated_output_size(self):
        estimated_output_size = transaction.Transaction.estimated_output_size
        self.assertEqual(estimated_output_size('CKuxk2HAuNHGxBbTn12ETygXPmXEBXiPZS'), 34)
        self.assertEqual(estimated_output_size('c1gtz1jXtfJWTNNnjncHkCZKKz1HeR9WqM'), 32)
       
    def test_errors(self):
        with self.assertRaises(TypeError):
            transaction.Transaction.pay_script(output_type=None, addr='')

        with self.assertRaises(BaseException):
            xpubkey_to_address('')

    def test_parse_xpub(self):
        res = xpubkey_to_address('ff0488b21e03ef2afea18000000089689bff23e1e7fb2f161daa37270a97a3d8c2e537584b2d304ecb47b86d21fc021b010d3bd425f8cf2e04824bfdf1f1f5ff1d51fadd9a41f9e3fb8dd3403b1bfe00000000')
        self.assertEqual(res, ('02e61d176da16edd1d258a200ad9759ef63adf8e14cd97f53227bae35cdb84d2f6', 'CKWzNWQ3u96mYPb6Jgdqg2eWoeW5iAFuYK'))

    def test_version_field(self):
        tx = transaction.Transaction(v2_blob)
        self.assertEqual(tx.txid(), "456853e9555d0f28121c092aa7969b3d1337e5c466f2c36f2bccb1075aae5ff9")

    def test_get_address_from_output_script(self):
        # the inverse of this test is in test_bitcoin: test_address_to_script
        addr_from_script = lambda script: transaction.get_address_from_output_script(bfh(script))
        ADDR = transaction.TYPE_ADDRESS
        PUBKEY = transaction.TYPE_PUBKEY
        SCRIPT = transaction.TYPE_SCRIPT

         # base58 p2pkh
        self.assertEqual((ADDR, 'CPBotnU31oHub1K2hKZQFx8yU61NkEkvNi'), addr_from_script('76a91449be5231b2e64ee929e9473259764580dea4098a88ac'))
        self.assertEqual((ADDR, 'CPN93EMEcnwGfp4HCUjaSR2w2hEQ9abCr5'), addr_from_script('76a9144bb276705796830d88a1d362db1996717aaf996188ac'))
        # almost but not quite
        self.assertEqual((SCRIPT, '76a9130000000000000000000000000000000000000088ac'), addr_from_script('76a9130000000000000000000000000000000000000088ac'))

        # base58 p2sh
        self.assertEqual((ADDR, 'cE7rPPonwWSb3ZpCZK2iFArTa8GFh9N8sD'), addr_from_script('a9148b74b28cc12df025038af213bd5d3472eb8fb7bb87'))
        self.assertEqual((ADDR, 'cNnntAcdzaPteKeMg32qaU3eUC65aj2VP9'), addr_from_script('a914ea9300561995f124b1916a85b30497f3e469b49187'))
        # almost but not quite
        self.assertEqual((SCRIPT, 'a912f47c8954e421031ad04ecd8e7752c947920687'), addr_from_script('a912f47c8954e421031ad04ecd8e7752c947920687'))

#####

    def _run_naive_tests_on_tx(self, raw_tx, txid):
        tx = transaction.Transaction(raw_tx)
        self.assertEqual(txid, tx.txid())
        self.assertEqual(raw_tx, tx.serialize())
        self.assertTrue(tx.estimated_size() >= 0)
    '''
    def test_txid_coinbase_to_p2pk(self):
        raw_tx = '01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff4103400d0302ef02062f503253482f522cfabe6d6dd90d39663d10f8fd25ec88338295d4c6ce1c90d4aeb368d8bdbadcc1da3b635801000000000000000474073e03ffffffff013c25cf2d01000000434104b0bd634234abbb1ba1e986e884185c61cf43e001f9137f23c2c409273eb16e6537a576782eba668a7ef8bd3b3cfb1edb7117ab65129b8a2e681f3c1e0908ef7bac00000000'
        txid = 'dbaf14e1c476e76ea05a8b71921a46d6b06f0a950f17c5f9f1a03b8fae467f10'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_coinbase_to_p2pkh(self):
        raw_tx = '01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff25033ca0030400001256124d696e656420627920425443204775696c640800000d41000007daffffffff01c00d1298000000001976a91427a1f12771de5cc3b73941664b2537c15316be4388ac00000000'
        txid = '4328f9311c6defd9ae1bd7f4516b62acf64b361eb39dfcf09d9925c5fd5c61e8'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_segwit_coinbase_to_p2pk(self):
        raw_tx = '020000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff0502cd010101ffffffff0240be402500000000232103f4e686cdfc96f375e7c338c40c9b85f4011bb843a3e62e46a1de424ef87e9385ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf90120000000000000000000000000000000000000000000000000000000000000000000000000'
        txid = 'fb5a57c24e640a6d8d831eb6e41505f3d54363c507da3733b098d820e3803301'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_segwit_coinbase_to_p2pkh(self):
        raw_tx = '020000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff0502c3010101ffffffff0240be4025000000001976a9141ea896d897483e0eb33dd6423f4a07970d0a0a2788ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf90120000000000000000000000000000000000000000000000000000000000000000000000000'
        txid = 'ed3d100577477d799107eba97e76770b3efa253c7200e9abfb43da5d2b33513e'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_segwit_coinbase_to_p2sh(self):
        raw_tx = '020000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff050214030101ffffffff02902f50090000000017a914ba582096f8647ca4195f55c8ef7e7e6e120e88b1870000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf90120000000000000000000000000000000000000000000000000000000000000000000000000'
        txid = 'e28ee5866ec0535fe5efac5ad350cbf4960ed981b471a0c4a6baad1d8168d3d7'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_p2pk_to_p2pkh(self):
        raw_tx = '010000000118231a31d2df84f884ced6af11dc24306319577d4d7c340124a7e2dd9c314077000000004847304402200b6c45891aed48937241907bc3e3868ee4c792819821fcde33311e5a3da4789a02205021b59692b652a01f5f009bd481acac2f647a7d9c076d71d85869763337882e01fdffffff016c95052a010000001976a9149c4891e7791da9e622532c97f43863768264faaf88ac00000000'
        txid = '90ba90a5b115106d26663fce6c6215b8699c5d4b2672dd30756115f3337dddf9'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_p2pk_to_p2sh(self):
        raw_tx = '0100000001e4643183d6497823576d17ac2439fb97eba24be8137f312e10fcc16483bb2d070000000048473044022032bbf0394dfe3b004075e3cbb3ea7071b9184547e27f8f73f967c4b3f6a21fa4022073edd5ae8b7b638f25872a7a308bb53a848baa9b9cc70af45fcf3c683d36a55301fdffffff011821814a0000000017a9143c640bc28a346749c09615b50211cb051faff00f8700000000'
        txid = '172bdf5a690b874385b98d7ab6f6af807356f03a26033c6a65ab79b4ac2085b5'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_p2pk_to_p2wpkh(self):
        raw_tx = '01000000015e5e2bf15f5793fdfd01e0ccd380033797ed2d4dba9498426ca84904176c26610000000049483045022100c77aff69f7ab4bb148f9bccffc5a87ee893c4f7f7f96c97ba98d2887a0f632b9022046367bdb683d58fa5b2e43cfc8a9c6d57724a27e03583942d8e7b9afbfeea5ab01fdffffff017289824a00000000160014460fc70f208bffa9abf3ae4abbd2f629d9cdcf5900000000'
        txid = 'ca554b1014952f900aa8cf6e7ab02137a6fdcf933ad6a218de3891a2ef0c350d'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_p2pkh_to_p2pkh(self):
        raw_tx = '0100000001f9dd7d33f315617530dd72264b5d9c69b815626cce3f66266d1015b1a590ba90000000006a4730440220699bfee3d280a499daf4af5593e8750b54fef0557f3c9f717bfa909493a84f60022057718eec7985b7796bb8630bf6ea2e9bf2892ac21bd6ab8f741a008537139ffe012103b4289890b40590447b57f773b5843bf0400e9cead08be225fac587b3c2a8e973fdffffff01ec24052a010000001976a914ce9ff3d15ed5f3a3d94b583b12796d063879b11588ac00000000'
        txid = '24737c68f53d4b519939119ed83b2a8d44d716d7f3ca98bcecc0fbb92c2085ce'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_p2pkh_to_p2sh(self):
        raw_tx = '010000000195232c30f6611b9f2f82ec63f5b443b132219c425e1824584411f3d16a7a54bc000000006b4830450221009f39ac457dc8ff316e5cc03161c9eff6212d8694ccb88d801dbb32e85d8ed100022074230bb05e99b85a6a50d2b71e7bf04d80be3f1d014ea038f93943abd79421d101210317be0f7e5478e087453b9b5111bdad586038720f16ac9658fd16217ffd7e5785fdffffff0200e40b540200000017a914d81df3751b9e7dca920678cc19cac8d7ec9010b08718dfd63c2c0000001976a914303c42b63569ff5b390a2016ff44651cd84c7c8988acc7010000'
        txid = '155e4740fa59f374abb4e133b87247dccc3afc233cb97c2bf2b46bba3094aedc'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_p2pkh_to_p2wpkh(self):
        raw_tx = '0100000001ce85202cb9fbc0ecbc98caf3d716d7448d2a3bd89e113999514b3df5687c7324000000006b483045022100adab7b6cb1179079c9dfc0021f4db0346730b7c16555fcc4363059dcdd95f653022028bcb816f4fb98615fb8f4b18af3ad3708e2d72f94a6466cc2736055860422cf012102a16a25148dd692462a691796db0a4a5531bcca970a04107bf184a2c9f7fd8b12fdffffff012eb6042a010000001600147d0170de18eecbe84648979d52b666dddee0b47400000000'
        txid = 'ed29e100499e2a3a64a2b0cb3a68655b9acd690d29690fa541be530462bf3d3c'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_p2sh_to_p2pkh(self):
        raw_tx = '01000000000101f9823f87af35d158e7dc81a67011f4e511e3f6cab07ac108e524b0ff8b950b39000000002322002041f0237866eb72e4a75cd6faf5ccd738703193907d883aa7b3a8169c636706a9fdffffff020065cd1d000000001976a9148150cd6cf729e7e262699875fec1f760b0aab3cc88acc46f9a3b0000000017a91433ccd0f95a7b9d8eef68be40bb59c64d6e14d87287040047304402205ca97126a5956c2deaa956a2006d79a348775d727074a04b71d9c18eb5e5525402207b9353497af15881100a2786adab56c8930c02d46cc1a8b55496c06e22d3459b01483045022100b4fa898057927c2d920ae79bca752dda58202ea8617d3e6ed96cbd5d1c0eb2fc02200824c0e742d1b4d643cec439444f5d8779c18d4f42c2c87cce24044a3babf2df0147522102db78786b3c214826bd27010e3c663b02d67144499611ee3f2461c633eb8f1247210377082028c124098b59a5a1e0ea7fd3ebca72d59c793aecfeedd004304bac15cd52aec9010000'
        txid = '17e1d498ba82503e3bfa81ac4897a57e33f3d36b41bcf4765ba604466c478986'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_p2sh_to_p2sh(self):
        raw_tx = '01000000000101b58520acb479ab656a3c03263af0567380aff6b67a8db98543870b695adf2b170000000017160014cfd2b9f7ed9d4d4429ed6946dbb3315f75e85f14fdffffff020065cd1d0000000017a91485f5681bec38f9f07ae9790d7f27c2bb90b5b63c87106ab32c0000000017a914ff402e164dfce874435641ae9ac41fc6fb14c4e18702483045022100b3d1c89c7c92151ed1df78815924569446782776b6a2c170ca5d74c5dd1ad9b102201d7bab1974fd2aa66546dd15c1f1e276d787453cec31b55a2bd97b050abf20140121024a1742ece86df3dbce4717c228cf51e625030cef7f5e6dde33a4fffdd17569eac7010000'
        txid = 'ead0e7abfb24ddbcd6b89d704d7a6091e43804a458baa930adf6f1cb5b6b42f7'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_p2sh_to_p2wpkh(self):
        raw_tx = '010000000001018689476c4604a65b76f4bc416bd3f3337ea59748ac81fa3b3e5082ba98d4e1170100000023220020ae40340707f9726c0f453c3d47c96e7f3b7b4b85608eb3668b69bbef9c7ab374fdffffff0218b2cc1d0000000017a914f2fdd81e606ff2ab804d7bb46bf8838a711c277b870065cd1d0000000016001496ad8959c1f0382984ecc4da61c118b4c8751e5104004730440220387b9e7d402fbcada9ba55a27a8d0563eafa9904ebd2f8f7e3d86e4b45bc0ec202205f37fa0e2bf8cbd384f804562651d7c6f69adce5db4c1a5b9103250a47f73e6b01473044022074903f4dd4fd6b32289be909eb5109924740daa55e79be6dbd728687683f9afa02205d934d981ca12cbec450611ca81dc4127f8da5e07dd63d41049380502de3f15401475221025c3810b37147105106cef970f9b91d3735819dee4882d515c1187dbd0b8f0c792103e007c492323084f1c103beff255836408af89bb9ae7f2fcf60502c28ff4b0c9152aeca010000'
        txid = '6f294c84cbd0241650931b4c1be3dfb2f175d682c7a9538b30b173e1083deed3'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_p2wpkh_to_p2pkh(self):
        raw_tx = '0100000000010197e6bf4a70bc118e3a8d9842ed80422e335679dfc29b5ba0f9123f6a5863b8470000000000fdffffff02402bca7f130000001600146f579c953d9e7e7719f2baa20bde22eb5f24119200e87648170000001976a9140cd8fa5fd81c3acf33f93efd179b388de8dd693388ac0247304402204ff33b3ea8fb270f62409bfc257457ca5eb1fec5e4d3a7c11aa487207e131d4d022032726b998e338e5245746716e5cd0b40d32b69d1535c3d841f049d98a5d819b1012102dc3ce3220363aff579eb2c45c973e8b186a829c987c3caea77c61975666e7d1bc8010000'
        txid = 'c721ed35767a3a209b688e68e3bb136a72d2b631fe81c56be8bdbb948c343dbc'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_p2wpkh_to_p2sh(self):
        raw_tx = '010000000001013c3dbf620453be41a50f69290d69cd9a5b65683acbb0a2643a2a9e4900e129ed0000000000fdffffff02002f68590000000017a914c7c4dcd0ddf70f15c6df13b4a4d56e9f13c49b2787a0429cd000000000160014e514e3ecf89731e7853e4f3a20983484c569d3910247304402205368cc548209303db5a8f2ebc282bd0f7af0d080ce0f7637758587f94d3971fb0220098cec5752554758bc5fa4de332b980d5e0054a807541581dc5e4de3ed29647501210233717cd73d95acfdf6bd72c4fb5df27cd6bd69ce947daa3f4a442183a97877efc8010000'
        txid = '390b958bffb024e508c17ab0caf6e311e5f41170a681dce758d135af873f82f9'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_p2wpkh_to_p2wpkh(self):
        raw_tx = '010000000001010d350cefa29138de18a2d63a93cffda63721b07a6ecfa80a902f9514104b55ca0000000000fdffffff012a4a824a00000000160014b869999d342a5d42d6dc7af1efc28456da40297a024730440220475bb55814a52ea1036919e4408218c693b8bf93637b9f54c821b5baa3b846e102207276ed7a79493142c11fb01808a4142bbdd525ae7bdccdf8ecb7b8e3c856b4d90121024cdeaca7a53a7e23a1edbe9260794eaa83063534b5f111ee3c67d8b0cb88f0eec8010000'
        txid = '51087ece75c697cc872d2e643d646b0f3e1f2666fa1820b7bff4343d50dd680e'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_input_p2wsh_p2sh_not_multisig(self):
        raw_tx = '0100000000010160f84fdcda039c3ca1b20038adea2d49a53db92f7c467e8def13734232bb610804000000232200202814720f16329ab81cb8867c4d447bd13255931f23e6655944c9ada1797fcf88ffffffff0ba3dcfc04000000001976a91488124a57c548c9e7b1dd687455af803bd5765dea88acc9f44900000000001976a914da55045a0ccd40a56ce861946d13eb861eb5f2d788ac49825e000000000017a914ca34d4b190e36479aa6e0023cfe0a8537c6aa8dd87680c0d00000000001976a914651102524c424b2e7c44787c4f21e4c54dffafc088acf02fa9000000000017a914ee6c596e6f7066466d778d4f9ba633a564a6e95d874d250900000000001976a9146ca7976b48c04fd23867748382ee8401b1d27c2988acf5119600000000001976a914cf47d5dcdba02fd547c600697097252d38c3214a88ace08a12000000000017a914017bef79d92d5ec08c051786bad317e5dd3befcf87e3d76201000000001976a9148ec1b88b66d142bcbdb42797a0fd402c23e0eec288ac718f6900000000001976a914e66344472a224ce6f843f2989accf435ae6a808988ac65e51300000000001976a914cad6717c13a2079066f876933834210ebbe68c3f88ac0347304402201a4907c4706104320313e182ecbb1b265b2d023a79586671386de86bb47461590220472c3db9fc99a728ebb9b555a72e3481d20b181bd059a9c1acadfb853d90c96c01210338a46f2a54112fef8803c8478bc17e5f8fc6a5ec276903a946c1fafb2e3a8b181976a914eda8660085bf607b82bd18560ca8f3a9ec49178588ac00000000'
        txid = 'e9933221a150f78f9f224899f8568ff6422ffcc28ca3d53d87936368ff7c4b1d'
        self._run_naive_tests_on_tx(raw_tx, txid)

    # input: p2sh, not multisig
    def test_txid_regression_issue_3899(self):
        raw_tx = '0100000004328685b0352c981d3d451b471ae3bfc78b82565dc2a54049a81af273f0a9fd9c010000000b0009630330472d5fae685bffffffff328685b0352c981d3d451b471ae3bfc78b82565dc2a54049a81af273f0a9fd9c020000000b0009630359646d5fae6858ffffffff328685b0352c981d3d451b471ae3bfc78b82565dc2a54049a81af273f0a9fd9c030000000b000963034bd4715fae6854ffffffff328685b0352c981d3d451b471ae3bfc78b82565dc2a54049a81af273f0a9fd9c040000000b000963036de8705fae6860ffffffff0130750000000000001976a914b5abca61d20f9062fb1fdbb880d9d93bac36675188ac00000000'
        txid = 'f570d5d1e965ee61bcc7005f8fefb1d3abbed9d7ddbe035e2a68fa07e5fc4a0d'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_negative_version_num(self):
        raw_tx = 'f0b47b9a01ecf5e5c3bbf2cf1f71ecdc7f708b0b222432e914b394e24aad1494a42990ddfc000000008b483045022100852744642305a99ad74354e9495bf43a1f96ded470c256cd32e129290f1fa191022030c11d294af6a61b3da6ed2c0c296251d21d113cfd71ec11126517034b0dcb70014104a0fe6e4a600f859a0932f701d3af8e0ecd4be886d91045f06a5a6b931b95873aea1df61da281ba29cadb560dad4fc047cf47b4f7f2570da4c0b810b3dfa7e500ffffffff0240420f00000000001976a9147eeacb8a9265cd68c92806611f704fc55a21e1f588ac05f00d00000000001976a914eb3bd8ccd3ba6f1570f844b59ba3e0a667024a6a88acff7f0000'
        txid = 'c659729a7fea5071361c2c1a68551ca2bf77679b27086cc415adeeb03852e369'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_regression_issue_4333(self):
        raw_tx = '0100000001a300499298b3f03200c05d1a15aa111a33c769aff6fb355c6bf52ebdb58ca37100000000171600756161616161616161616161616161616161616151fdffffff01c40900000000000017a914001975d5f07f3391674416c1fcd67fd511d257ff871bc71300'
        txid = '9b9f39e314662a7433aadaa5c94a2f1e24c7e7bf55fc9e1f83abd72be933eb95'
        self._run_naive_tests_on_tx(raw_tx, txid)

    # see https://bitcoin.stackexchange.com/questions/38006/txout-script-criteria-scriptpubkey-critieria
    def test_txid_invalid_op_return(self):
        raw_tx = '01000000019ac03d5ae6a875d970128ef9086cef276a1919684a6988023cc7254691d97e6d010000006b4830450221009d41dc793ba24e65f571473d40b299b6459087cea1509f0d381740b1ac863cb6022039c425906fcaf51b2b84d8092569fb3213de43abaff2180e2a799d4fcb4dd0aa012102d5ede09a8ae667d0f855ef90325e27f6ce35bbe60a1e6e87af7f5b3c652140fdffffffff080100000000000000010101000000000000000202010100000000000000014c0100000000000000034c02010100000000000000014d0100000000000000044dffff010100000000000000014e0100000000000000064effffffff0100000000'
        txid = 'ebc9fa1196a59e192352d76c0f6e73167046b9d37b8302b6bb6968dfd279b767'
        self._run_naive_tests_on_tx(raw_tx, txid)
        '''

# these transactions are from Bitcoin Core unit tests --->
# https://github.com/bitcoin/bitcoin/blob/11376b5583a283772c82f6d32d0007cdbf5b8ef0/src/test/data/tx_valid.json

    def test_txid_bitcoin_core_0001(self):
        raw_tx = '0100000060e9325b019658880249653f3194d5c1bc9c8058d82059984fb72ac1eb28107cf1a65763eb0200000049483045022100b55af48f6d04cd96c890cf763812d7bbd08b2773373d34cba978e7da24119e5702205ee61f5a37997a05ddbb564dd9ca275311494f67fadd639266c1c0274e7097cf01ffffffff02000000000000000000c0816dc602000000232102ca3bafb0040cb18c25ae5c0d4a6aee48cc82c66d5aedf10a6298b5bf7e90bfc8ac00000000'
        txid = '2ad719eafd618b50c4c15f9365912e7e03ec812d33e0a17edd9f365f469013c4'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0002(self):
        raw_tx = '0100000070e9325b01e66ed524c301806f6bd7482d1107097217e6e3a4586cd5cfe33a5c05e1723ae0020000004948304502210089bf42360c35f6789e3b62e8927b3bddf37f0548e08cdf93410f67fdfff34734022020235d34142f4425983f60cf015fcd3cfc30a47a40a5a1bd2b6baf0a561a3c9701ffffffff03000000000000000000c04a8cab030000002321028c9348c379d20eb512e84119d7c85541e3874f06838d0f5963658bb13151d33aac008d9bab030000002321028c9348c379d20eb512e84119d7c85541e3874f06838d0f5963658bb13151d33aac00000000'
        txid = '581c866c050d6719c41e9fa84003ac055e1f591cd6103ce9f9260624d1f14eba'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0003(self):
        raw_tx = '01000000b0e9325b0144c4f57da59503b1b15c4e0683768911ebb038685779a4b228898bfe603a74b70100000049483045022100defb8c5642a7d4e2c0d4e274bdd7f298ccde2dcdcecd4910b2ef49d815951d6402205b45b344578b3d910cbe9ba1a4d476e3ffa08af3dc97cb069c2cc9abcd01dfee01ffffffff02000000000000000000c0816dc602000000232102ca3bafb0040cb18c25ae5c0d4a6aee48cc82c66d5aedf10a6298b5bf7e90bfc8ac00000000'
        txid = 'ce470fd3ccdebacaa14e9779b09323c1afe72a3046598b416c95a2370ef4c5a6'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0004(self):
        raw_tx = '01000000f0e9325b0195c1244c7ac1376aaa9b56e1eab1bb6b8aefeb17ee2c81e27bc7c86ec181d57d010000004847304402200839f9b939a5ea136003b05e85fcaad6f2405e810f415199d2ccb581305f552b02202e73c71f43329598d4bdcdc2f843b29e10dd2e28e1ea03696cfbe90b522c968701ffffffff020000000000000000000023e48603000000232103c0c30d173c8478ceaaba836e8cae3c8c4e43f88f6d555600be124781b533956bac00000000'
        txid = '7a0c6634a314045c676f444b25506f8874fecbec8334ec5df95934f149763534'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0005(self):
        raw_tx = '0100000000ea325b0190608b81c056d20e222e33ed1091d53fe8482b4b7c4df9627d20a66088a5dce80100000049483045022100aedcf490f8cf32d20634411749f7cb77c81f5bbf00e4fbea2d1fb38319a8f78702201d05e145aa99f28622759a8429a4d098e2a4f09e3a591217ddb943db3f1cb1c501ffffffff02000000000000000000403734b503000000232102cb2288332efdcec0ed030bbb0bfe9b0f706bfbcadfa355c4496f0d09827e1893ac00000000'
        txid = 'cb1641bfc79ba506f74800a6545d7e360112fc02da4bbbc03daaff9cd6b8543e'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0006(self):
        raw_tx = '0100000050ea325b01ceb5612c487fc380bd17820016000f8bd674d62bbea7934021b97cb29fb21e5a0100000048473044022021ee14838aea354977e5ea379a31186c621c3ac5498217eec220ab2baf92d95702204c0fecc278861f9bad91ef83c2a805d28df76f981d894a33411fe70ba4cc3a3501ffffffff02000000000000000000c077d86304000000232103c03b6abe62f77c7162e7d1c8f9a268d634130fe7f7615b513e5f08fa9b97acd7ac00000000'
        txid = '6b6067f88369d62a554c804de2e4006386d85329dbde3ee5bf5acb439c45025f'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0007(self):
        raw_tx = '0100000090ea325b01c222e2eb88d9a702b5dc36b353c5a4a7047dea6bb350083c2a41cbb2ba7b30b30100000048473044022006932c2c16c95ed4657eafdc59ff529100331a79460f156d51aa977e74d0d1e502205c750ad51b3d65a52b7e847e5107f2bf2c5ea266138c94f395309cf1a172b3d701ffffffff02000000000000000000004b4f7504000000232102f8992a1b5132b0a68ff19c592517eb4c3e512b3201a273ea984144fa4439a9a4ac00000000'
        txid = 'c58774a72aff03e60ce4828deb591d11177a6d8fb096f4dc286e2fcf72266c38'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0008(self):
        raw_tx = '01000000f0ea325b01dadfe6c666dfc064c5412827a49ba16a2e81e16b06c6d4c507cbc08e4deda9c20100000048473044022006d195aa92bedd63d82f2ded09063f79af089239c8c35c0b494060563990745602207bdacd8a05890f0be0d407f21d7794977bb7954af59d53aa1746b09f6167defd01ffffffff02000000000000000000c0816dc602000000232102ca3bafb0040cb18c25ae5c0d4a6aee48cc82c66d5aedf10a6298b5bf7e90bfc8ac00000000'
        txid = 'e8e0a92617c350567a8c7e8017183cb35cbaa5b77ec5fb5552f69389d8ffb7dd'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0009(self):
        raw_tx = '0100000040eb325b01aa0cee916592cbb9e8a117120b8f0d9850ae95f6c95bc268cda12d73dd2e72a501000000484730440220775359bfb9655a36f54045a25fa2f05163855e1686b6384a4e4bed145a65bfc802205d1fe62fa9dd157e75f5b4fe7468415920b95c536295237dfa284972305ceca901ffffffff020000000000000000004084fd8003000000232103c0c30d173c8478ceaaba836e8cae3c8c4e43f88f6d555600be124781b533956bac00000000'
        txid = '0a04375a7f0478f2d3e25c927350cfc64913a6e5a8daeb14ada9648a70c42e17'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0010(self):
        raw_tx = '01000000b0eb325b01957425c514bcaef5855a745c45844390fac27ae6956595ef4710759ff3eebd63010000004847304402201be2a5bc941bcdda5290185b8328f8a9e55f23c6651099f21f817c757e1dcf3b0220270623d66d68c71f1966e8ae63e8150e42278cdb45b50b507af68b1ee509cfd401ffffffff020000000000000000008035c963040000002321032ddb8f8e8fd505a72beda82e85a8b4f72f14cbabe3c6eacf7d559cebdd3b873aac00000000'
        txid = 'e482906af82252b76f39ba86ce05a6841a09d0b5496f7a8501bbafd6ca775c0f'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0011(self):
        raw_tx = '01000000f0eb325b011710b6e78c9d903fc6f0e5a0070438cb5bfe58459630575286718ab9fc2952910100000049483045022100f13e22d88333ec56d7f17735ddb2f26d472eeccbd3d9aee9f0067c40b706181d022009680f80108cb98c3dcab0e8908706a8176438af2f67a879d9adf77f8aa67c2f01ffffffff020000000000000000008002174e0400000023210262aa48b68f0be81bbbbf7176e8e39ad386b7dab54fe1c7fc6b0ff802a73a08d3ac00000000'
        txid = '41ebe528bdcc47e6d62cf7b789c67977d9173fa2fd3e91beb89c4ab6427d000c'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0012(self):
        raw_tx = '0100000070ec325b016e1aae1c32afab53c700b9fa49d04590c3fc23649422af17f913daaab956b1c001000000484730440220226a3db5bfd76754539c6f6b46a04f2dc56c2057e715b8f2d90e84f18e5cdf0f0220679b021fb73a874586ca2bc046221bb5904bbe55a22a93c49fe40cac63714cb301ffffffff02000000000000000000c039c46f0400000023210229d2fd5099d4fbefb7874837abe7e5d741f229d5ce00ea07347ba29c2a6cc41fac00000000'
        txid = 'fa107d218676183fa40d0cbb528cab9734aa34060a82f1092249cba4f9ebb646'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0013(self):
        raw_tx = '0100000080ec325b019147208afc4d7ea423363afaf5b2f43054c8d8496a381c87efaad691ca5d114d01000000484730440220091de9a2444329fcdc02107d3d9958f7f7e14a8f70f1ac8df9402f32c597df21022056ee2c734933bcd89374b3c4029dc6ff73bde13732304b401e26a040440f2da501ffffffff03000000000000000000003339a9030000002321036c103d4f3381a3ae6b5414ca181f86ebc59a0396d4c6e653c2fdf2ea19418636ac003339a9030000002321036c103d4f3381a3ae6b5414ca181f86ebc59a0396d4c6e653c2fdf2ea19418636ac00000000'
        txid = '573fa32f8ee4bbf5a1061107ccab121e5a8b495f1d591c80b7889a72ff981768'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0014(self):
        raw_tx = '0100000000ed325b018e3e0537e7800c980dba4d3e3f49ba6bdd5dda41589d204cda96974ca3df5c800100000049483045022100aa69f5b7d7e7e2fcbfc86362c65284cc8a2fce038a9112ed921c7ec63a57394b02202fbf5ed101495fbae0c83c6157c80af4d74969f0f000559d50a245d7d89ca29001ffffffff020000000000000000000061f87a03000000232103c0c30d173c8478ceaaba836e8cae3c8c4e43f88f6d555600be124781b533956bac00000000'
        txid = 'b0928a17efc4c923edd3efd54c23551bc9bb2250da829119a89fd9638034e27d'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0015(self):
        raw_tx = '0100000020ed325b01738e72b82020226b9a9840ed4a93f1fc4698c8c4d80b41fa4e7a44fa4ee7accd0100000049483045022100a4c8f03d1dd87ab97cecad295894f8cc3f31482b18da537a67ca4dd73989881c022043e83ecfda9532f40927eb523cbe7ab1fe3d431096caf1b8cd42c32e7b41c06801ffffffff02000000000000000000c0fbaf7b04000000232102e8dabc3c91c2ed8765f319280c1546f839197723034a2b80bf4384e1ee8a0ccbac00000000'
        txid = '5655003dee82cf7b8b9082ce24d2db4d97a5dd8981ac2b3ad9206857fb7c1b64'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0016(self):
        raw_tx = '0100000040ed325b0110d2de3b586758b08fde466256ede480198d12c44af6272d6314dd47169284aa0200000049483045022100f864a0eb2f853ab49905fb0137a394b95c0e32dbcdcbbfec96d292e9c6811d7702204fd6a3924782b5bd1c2926926e9da8c07596a24f19128ee272ad63ff6fce378301ffffffff0300000000000000000080b23c1e090000002321033f5bca2bbf9684ae15b28a4104ce2a34546c1f33752a53907ebd9ccb0d35ded6acc0f44b1e090000002321033f5bca2bbf9684ae15b28a4104ce2a34546c1f33752a53907ebd9ccb0d35ded6ac00000000'
        txid = '3df858c6f1eb5f8f9466f9a381d68302b9d8785017436e0a12dd856f7c2b221d'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0017(self):
        raw_tx = '0100000090ed325b0149584a19627fc546cecdf41bba14508fcffb61688e5a1de912dac1753368dcb90100000048473044022076694a13be0793162d12f30f521ea736ea33f994e2902129e99f96a2eb9ea34702206025d53896258245e5d91f6c54e3ad7d6ba280be8e9bef3b9dc7e181ad242dff01ffffffff02000000000000000000002f0aa40400000023210251a53e18975df5c5149e234db5ea88c75614a162b2ac770c1a09e5ad9a287cc7ac00000000'
        txid = '182b102c735547b3389fd895829e04759f8e25d41721b2ea42f751952ba7830d'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0018(self):
        raw_tx = '01000000b0ed325b01d4dda6222e6439518d362140e1bf4341cf30de61f32a3927b2227942f6e6b7be020000004847304402207dfb0a82176a759af94958dc7bfb25d951b7e5a1c2344015dcb07ef86a137c2b022013b821a955785776a85ca63619a590f4be14dacb858dad008d3d55cea9eded7001ffffffff02000000000000000000c008134403000000232102d90b63792d24f9f9839e6a1c5fe41bc7b3c261a5b3e9e68130de875858a205edac00000000'
        txid = '50095a53f21712f80da53cc67a2b171716f49db19c602a7cfeaecd5183aa1c0a'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0019(self):
        raw_tx = '0100000010ee325b017d31fc40fc2a5e4ab8ea0b8635b025ca5208215523c6584dc9341f04c7c21c1d0100000048473044022078b7b2ef16090452ca7ee7090ca993fb253c76b60f279fcb93516bf7846f07330220318926dea3ba19a9621467a97d4e04b1c63ffd63f7a710f52326d603604ea5b001ffffffff020000000000000000008035c96304000000232102e8dabc3c91c2ed8765f319280c1546f839197723034a2b80bf4384e1ee8a0ccbac00000000'
        txid = '2024b2bede1c754cec8429abf92919154ab1f8debd533de756a36b0c91ef1ae2'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_bitcoin_core_0020(self):
        raw_tx = '0100000020ee325b017614d88d2a7f43cc21983a182cf929b7164cf0e8c5fdb5dd768810147e43b785010000004847304402203b8248424fb459af8347af820bab2162911ae7d717368c43b38f64cbc0a2fae902200a0553b54935adf888d73dcf8b8617152d22d351f8e7d2e0b1db27a38b94eee501ffffffff02000000000000000000c039c46f0400000023210229d2fd5099d4fbefb7874837abe7e5d741f229d5ce00ea07347ba29c2a6cc41fac00000000'
        txid = 'f184db54907410e90c72d8b5c75827cd14216709361ac0d25e818643b38925fa'
        self._run_naive_tests_on_tx(raw_tx, txid)


# txns from EXOS Core ends <---

'''
class TestTransactionTestnet(TestCaseForTestnet):

    def _run_naive_tests_on_tx(self, raw_tx, txid):
        tx = transaction.Transaction(raw_tx)
        self.assertEqual(txid, tx.txid())
        self.assertEqual(raw_tx, tx.serialize())
        self.assertTrue(tx.estimated_size() >= 0)

# partial txns using our partial format --->
    # NOTE: our partial format contains xpubs, and xpubs have version bytes,
    # and version bytes encode the network as well; so these are network-sensitive!

    def test_txid_partial_segwit_p2wpkh(self):
        raw_tx = '45505446ff000100000000010115a847356cbb44be67f345965bb3f2589e2fec1c9a0ada21fd28225dcc602e8f0100000000fdffffff02f6fd1200000000001600149c756aa33f4f89418b33872a973274b5445c727b80969800000000001600140f9de573bc679d040e763d13f0250bd03e625f6ffeffffffff9095ab000000000000000201ff53ff045f1cf6014af5fa07800000002fa3f450ba41799b9b62642979505817783a9b6c656dc11cd0bb4fa362096808026adc616c25a4d0a877d1741eb1db9cef65c15118bd7d5f31bf65f319edda81840100c8000f391400'
        txid = '63ff7e99d85d8e33f683e6ec84574bdf8f5111078a5fe900893e019f9a7f95c3'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_partial_segwit_p2wpkh_p2sh_simple(self):
        raw_tx = '45505446ff0001000000000101d0d23a6fbddb21cc664cb81cca96715baa4d6dbe5b7b9bcc6632f1005a7b0b840100000017160014a78a91261e71a681b6312cd184b14503a21f856afdffffff0134410f000000000017a914d6514ca17ecc31952c990daf96e307fbc58529cd87feffffffff40420f000000000000000201ff53ff044a5262033601222e800000001618aa51e49a961f63fd111f64cd4a7e792c1d7168be7a07703de505ebed2cf70286ebbe755767adaa5835f4d78dec1ee30849d69eacfe80b7ee6b1585279536c30000020011391400'
        txid = '2739f2e7fde9b8ec73fce4aee53722cc7683312d1321ded073284c51fadf44df'
        self._run_naive_tests_on_tx(raw_tx, txid)

    def test_txid_partial_segwit_p2wpkh_p2sh_mixed_outputs(self):
        raw_tx = '45505446ff00010000000001011dcac788f24b84d771b60c44e1f9b6b83429e50f06e1472d47241922164013b00100000017160014801d28ca6e2bde551112031b6cb75de34f10851ffdffffff0440420f00000000001600140f9de573bc679d040e763d13f0250bd03e625f6fc0c62d000000000017a9142899f6484e477233ce60072fc185ef4c1f2c654487809698000000000017a914d40f85ba3c8fa0f3615bcfa5d6603e36dfc613ef87712d19040000000017a914e38c0cffde769cb65e72cda1c234052ae8d2254187feffffffff6ad1ee040000000000000201ff53ff044a5262033601222e800000001618aa51e49a961f63fd111f64cd4a7e792c1d7168be7a07703de505ebed2cf70286ebbe755767adaa5835f4d78dec1ee30849d69eacfe80b7ee6b1585279536c301000c000f391400'
        txid = 'ba5c88e07a4025a39ad3b85247cbd4f556a70d6312b18e04513c7cec9d45d6ac'
        self._run_naive_tests_on_tx(raw_tx, txid)

# end partial txns <---
'''

class NetworkMock(object):

    def __init__(self, unspent):
        self.unspent = unspent

    def synchronous_send(self, arg):
        return self.unspent
